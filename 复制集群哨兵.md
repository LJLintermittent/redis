## 复制

在redsis中，用户可以通过slaveof + ip地址 + 端口号的方式在从服务器上执行，ip地址加端口号指定的是主服务器的，从而可以实现主从复制，去别的服务器复制的叫从服务器，提供给别人复制的是主服务器

进行主从复制的服务器之间应该保证数据的一致性。

### redis2.8以前的旧版复制原理

redis的复制功能可以分为同步和命令传播两部分：

1.同步操作用于将从服务器的状态更新到主服务器的状态

2.命令传播作用是在主服务器又增加了新的写命令后，需要将这个命令也传播给从服务器

#### 同步

当客户端向从服务器发送slaveof命令时，就是要求从服务器复制主服务器，那么从服务器需要首先进行一个同步操作，也就是将主服务器的状态更新到从服务器的，以此达到数据的一致性

从服务器对主服务器的同步操作是通过sync命令来完成的，步骤：

1.从服务器向主服务器发送sync命令

2.收到sync命令的主服务器开始执行bgsave命令，生成一个rdb文件，并使用一个缓冲区记录在生成rdb文件的这段时间新生成的写命令

3.当主服务器的bgsave执行完以后，主服务器会把这个生成的rdb文件发送给从服务器，从服务器载入这个rdb文件，主服务器还要发送缓冲区里面记录的写命令，从服务器收到以后执行完毕，这时候两个服务器的状态就达到了一致

#### 命令传播

经过同步后，两个服务器达到了短暂的一致，但是主服务器还会不断的接收新来的写命令，所以主服务器还要将命令传播到所有的从服务器，以此来维持住同步状态。

#### 旧版复制原理

在redis2.8以前，从服务器对主服务器的复制可以分为两种情况：

1.初次复制：从服务器以前没有复制过，或者当前要复制的主服务器和以前复制的主服务器不同

2.断线后重复制：处于命令传播阶段的主从服务器如果断开了网络连接，然后从服务器经过一段时间又恢复了网络连接，那么需要继续复制

对于初次复制，旧版的复制可以比较好的完成工作，但对于这个断线后重复制，旧版的效率太低下

因为断线重连后，从服务器还是使用sync命令进行完整复制，重复一遍生成rdb文件，写缓冲区等等这个流程，其实断线重连后只需要恢复断线的这个时间段主服务器新写进来的命令就OK了

~~~wiki
sync是一项非常耗费资源的操作
在复制的时候，每次执行sync命令，将会发生如下操作：
1.主服务器需要执行bgsave来生成rdb，这个操作会耗费大量主服务器的cpu，内存，磁盘io资源
2.主服务器需要将生成的rdb文件发送给从服务器，这个过程会耗费主从服务器大量的网络资源，并对主服务器的命令响应产生影响
3.接收到的rdb文件载入到从服务器，从服务器在rdb载入期间丧失所有读写能力
所以sync是一个很重的操作，所以尽量只在有必要的时候才执行sync
而断线重连恢复部分数据这种场景，很明显就不需要sync
~~~

#### 新版复制原理

新版使用psync代替sync

psync具有完整重同步和部分重同步两个功能

其中完整重同步用于处理初次复制情况，完整重同步的执行步骤和执行sync的步骤一样，都是让主服务器创建rdb文件，以及发送缓存区里面的写命令来进行同步

而部分重同步用于断线重连这种情况，当从服务器断线重连后，如果条件允许，主服务器将把断开后执行的命令发送给从服务器，从服务器只要接收并执行这些命令，就可以恢复到一致状态。

psync命令的部分重同步模式解决了旧版复制功能在处理断线能力方面效率低下的问题

#### 部分重同步的实现原理

部分重同步功能主要由三个部分组成：

1.主服务器的复制偏移量和从服务器的复制偏移量

2.主服务器的复制积压缓冲区

3.runid，每个服务器一个特定的id

复制偏移量

用来记录复制到了哪里，比如主服务器的offset是1000，从服务器的offset也是1000的话，那么说明两个服务器此时的状态是一致的。如果主服务器新增了写命令，那么offset会相应的增大。

如果在断线前主从服务器之间的复制偏移量是一致的，然后主从之间断开了连接，那么主服务器的偏移量会在这个阶段增加，当从服务器连接上来后将会向主服务器发送psync命令。

#### 复制积压缓冲区

复制积压缓冲区是一个由主服务器维护的FIFO先进先出的一个队列，并且大小默认是1M，长度是固定的，不会动态扩容

当主服务器进行命令传播的时候，不仅要把命令发送给所有的从服务器，还会将命令写入到复制积压缓冲区，复制积压缓冲区会保存部分最近发送的命令，并且复制积压缓冲区里面的每个字节都会对应一个准确的偏移量，用来做准确的部分重同步

当从服务器连接上来后，从服务器通过psync将自己的复制偏移量也带上，主服务器根据这个复制偏移量来决定进行哪种模式的psync

如果offset偏移量之后的数据仍然在缓冲区，那么进行部分重同步

如果offset偏移量之后的数据不在缓冲区了，说明已经断线很久了，那么复制积压缓冲区都已经没有存下，那么需要执行完整重同步

主服务器检查后发现应该是部分重同步，那么恢复一个+continue，然后主服务器会将积压缓冲区中这个偏移量后面的数据给从服务器发过去。从服务器只会接收丢失部分的数据，大大提高了断线复制的效率

另外这个积压缓冲区需要根据断线时间+主服务器写入速率的乘积来做一个设置

以此来尽量让所有的断线恢复都能在复制积压缓冲区中找到偏移量

#### 服务器运行ID

除了复制偏移量和复制积压缓冲区以外，实现部分重同步还需要带上runid，如果断线重连后从服务器发来的runid（发来的这个runid是保存的主服务器的runid）等于现在的主服务器id，那么说明断线前你的主服务器就是我，所以执行部分重同步，否则完整重同步

这个runid是当从服务器对主服务器进行初次复制时，主服务器会将自己的runid传送给从服务器，从服务器进行psync命令发送的时候需要带上这个runid。

psync的格式是 psync  runid offset，进行复制的时候除了确认这些参数以外，在真正复制之前还有一次握手的过程，+continue回复

#### 复制的完整实现

#### 1.设置主服务器的地址和端口号 salveof 127.0.0.1 6379

#### 2.建立socket连接

在slaveof命令执行以后，从服务器将根据命令所设置的ip地址和端口号，创建连向主服务器的套接字连接

如果从服务器创建的socket连接能成功连接到主服务器，那么从服务器将为这个套接字关联一个专门用于处理复制工作的文件事件处理器，这个处理器将负责执行之后的复制工作，比如接收rdb文件以及接收来的传播命令等

而主服务器在accept从服务器的套接字连接之后，将为该套接字创建相应的客户端状态，并将从服务器看做是一个客户端来对待，这时从服务器将具有服务器和客户端两个状态，从服务器可以向主服务器发送命令。

#### 3.发送ping命令

从服务器成为主服务器的客户端后，做的第一个事情就是发送ping命令，这个ping命令有两个作用：

1.虽然建立了套接字连接，但是双方并未使用该套接字进行任何网络通信，通过发送ping命令来检查套接字的读写状态是否正常

2.如果主服务器向从服务器返回一个命令回复，但从服务却不能在规定的时间内读取，当出现这种情况，需要断开连接

如果主服务器向从服务器返回一个错误，那么表示主服务器暂时没有办法处理从服务器的命令请求，不能执行复制的后序操作

如果从服务器读到了pong命令,那么表示主从服务器之间的网络连接状态是一致的,这种情况下,可以继续执行后序的复制操作

注意,如果ping后回复超时或者主服务器返回一个错误,那么从服务器会断开并重连

#### 4.身份验证

从服务器收到pong后,然后就是根据服务器的配置决定是否进行身份验证

masterauth和requirespass选项决定是否需要认证以及是否需要密码

#### 5.发送端口信息

身份验证后从服务器将向主服务器发送从服务器的监听端口号

主服务器在收到以后,会将端口号记录在从服务器对应的客户端状态的属性中

#### 6.同步

在这一步从服务器将向主服务器发送psync命令,执行同步操作.

需要注意的是在执行psync命令前只有从服务器是主服务的客户端,到了这一步,两者互为对方的客户端

正因为主服务器成为了从服务器的客户端,所以主服务器才可以通过发送写命令来改变从从服务器的状态

#### 7.命令传播

完成了同步后,就进入了命令传播阶段,这时主服务器只要一直将自己执行的写命令发送给从服务器,而从服务一直接收来自主服务器的命令,那么两者就可以一直是一致状态

### 心跳检测

在命令传播阶段,从服务器默认会以每秒一次的频率,向主服务器发送命令

replconf ack <replication offset>

其中replication offset就是从服务的当前复制偏移量

replconf ack 这个命令有三个作用:
1.检测主从网络连接状态

2.辅助实现min-slaves

3.检测命令丢失

第一点不用说,主要说二三点:
辅助实现min-slaves,redis的min-slaves-to-write和min-slaves-max-log选项可以让主服务器在不安全的情况下,停止写命令

min-slaves-to-write 设置为3,min-slaves-max-log设置为10,代表的意思从服务器的数量少于三个,或者三个从服务器的延迟值都大于或等于10,那么主服务器将拒绝执行写命令

另外replconf ack 后面带上的偏移量还可以检测在这一秒内主服务器有没有丢失命令

如果发现偏移量不一致,那么可能是主服务传播命令丢失了,需要补发数据

这个补发数据的原理和部分重同步的原理差不多,区别就是一个是断线了,一个没断线

在redis2.8以前,如果命令在传播过程中丢失了,那么主服务器和从服务器都不会注意到

所以为了保证数据的一致性,最好选用redis2.8以上版本

~~~wiki
复制部分总结:
部分重同步通过复制偏移量和复制积压缓冲区和runid三个来实现
在复制刚开始时,从服务器会成为主服务器的客户端,并通过向主服务器发送命令来执行复制的前面的步骤,而到了同步阶段,两者互为主从
并且还有心跳检测机制,防止数据丢失
~~~



