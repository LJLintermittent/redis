## 复制

在redsis中，用户可以通过slaveof + ip地址 + 端口号的方式在从服务器上执行，ip地址加端口号指定的是主服务器的，从而可以实现主从复制，去别的服务器复制的叫从服务器，提供给别人复制的是主服务器

进行主从复制的服务器之间应该保证数据的一致性。

### redis2.8以前的旧版复制原理

redis的复制功能可以分为同步和命令传播两部分：

1.同步操作用于将从服务器的状态更新到主服务器的状态

2.命令传播作用是在主服务器又增加了新的写命令后，需要将这个命令也传播给从服务器

#### 同步

当客户端向从服务器发送slaveof命令时，就是要求从服务器复制主服务器，那么从服务器需要首先进行一个同步操作，也就是将主服务器的状态更新到从服务器的，以此达到数据的一致性

从服务器对主服务器的同步操作是通过sync命令来完成的，步骤：

1.从服务器向主服务器发送sync命令

2.收到sync命令的主服务器开始执行bgsave命令，生成一个rdb文件，并使用一个缓冲区记录在生成rdb文件的这段时间新生成的写命令

3.当主服务器的bgsave执行完以后，主服务器会把这个生成的rdb文件发送给从服务器，从服务器载入这个rdb文件，主服务器还要发送缓冲区里面记录的写命令，从服务器收到以后执行完毕，这时候两个服务器的状态就达到了一致

#### 命令传播

经过同步后，两个服务器达到了短暂的一致，但是主服务器还会不断的接收新来的写命令，所以主服务器还要将命令传播到所有的从服务器，以此来维持住同步状态。

在redis2.8以前，从服务器对主服务器的复制可以分为两种情况：

1.初次复制：从服务器以前没有复制过，或者当前要复制的主服务器和以前复制的主服务器不同

2.断线后重复制：处于命令传播阶段的主从服务器如果断开了网络连接，然后从服务器经过一段时间又恢复了网络连接，那么需要继续复制

对于初次复制，旧版的复制可以比较好的完成工作，但对于这个断线后重复制，旧版的效率太低下

因为断线重连后，从服务器还是使用sync命令进行完整复制，重复一遍生成rdb文件，写缓冲区等等这个流程，其实断线重连后只需要恢复断线的这个时间段主服务器新写进来的命令就OK了

~~~wiki
sync是一项非常耗费资源的操作
在复制的时候，每次执行sync命令，将会发生如下操作：
1.主服务器需要执行bgsave来生成rdb，这个操作会耗费大量主服务器的cpu，内存，磁盘io资源
2.主服务器需要将生成的rdb文件发送给从服务器，这个过程会耗费主从服务器大量的网络资源，并对主服务器的命令响应产生影响
3.接收到的rdb文件载入到从服务器，从服务器在rdb载入期间丧失所有读写能力
所以sync是一个很重的操作，所以尽量只在有必要的时候才执行sync
而断线重连恢复部分数据这种场景，很明显就不需要sync
~~~





