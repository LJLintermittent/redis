~~~wiki
发布与订阅部分总结：
在服务器状态的pubsub_channels字典里保存了所有频道的订阅关系，subscribe命令负责将客户端与被订阅的频道关联到这个字典里面，而unsubscribe命令则负责接触客户端和被退订频道之间的关系
在服务器状态的pubsub_patterns链表中保存了所有模式的订阅关系，psubscribe命令负责将客户端和被订阅的模式记录到这个链表中。而punsubscribe命令负责接触客户端与被退订模式之间的关系
publish命令通过访问pubsub_channels字典来向频道的所有订阅者发布消息，通过访问pubsub_patterns来向所有匹配频道的模式的订阅者发送消息
pubsub命令的三个子命令都是通过读取pubsub_channels字典和pubsub_patterns链表中的信息来实现的
~~~

### 事务

redis通过mutil，watch，exec命令来实现事务功能，事务提供了一种将多个请求打包，然后一次性，按顺序执行完成的特性，并且在事务执行期间，服务器不会中断事务而去执行其他客户端的命令请求，它会将事务中的所有命令执行完毕，然后才去处理其他客户端的命令请求。

redis的事务总是从mutil命令开始，接着将多个命令放入事务中，最后由exec命令将这个事务提交给服务器执行

#### 事务开始

mutil命令标志着redis事务的开始，mutil命令可以将执行命令的客户端从非事务状态切换到事务状态，这个切换操作是通过在redisclient结构中的flags属性打开redis_mutil标志来实现的，mutil命令实现就可以理解为打开客户端状态的事务标识

命令入对：

当一个客户端处于非事务状态时，它的命令总会被立即执行

与之不同的是当一个客户端是事务状态，那么服务器会根据命令的不同来决定是否立即执行

1.如果客户端发送的命令为exec，discard，watch，mutil等命令时，处于事务状态的客户端也会立即执行这些命令，与此对应的，如果是这四个命令之外的其他命令，那么服务器不会立即执行，而是将这个命令放入一个事务队列里面，然后向客户端返回一个queued回复

在事务状态下，服务器要通过判断命令来选择是否立即执行

